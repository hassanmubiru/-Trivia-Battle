<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Battle - Fully On-Chain</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .question-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .option {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e0e0e0;
        }
        
        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .match-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-waiting {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-active {
            background: #55efc4;
            color: #00b894;
        }
        
        .status-completed {
            background: #dfe6e9;
            color: #636e72;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .error {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .success {
            background: #55efc4;
            color: #00b894;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .info {
            background: #74b9ff;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            margin: 10px 0;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Trivia Battle</h1>
            <p>Fully On-Chain Trivia Game - No Database Required!</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Celo Sepolia Testnet</p>
        </div>

        <div id="walletSection" class="card">
            <h2>Connect Wallet</h2>
            <button class="btn" onclick="connectWallet()">Connect MetaMask</button>
            <div id="walletInfo"></div>
        </div>

        <div id="statsSection" class="stats-grid" style="display: none;">
            <div class="stat-card">
                <h3>Total Questions</h3>
                <div class="value" id="totalQuestions">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Matches</h3>
                <div class="value" id="activeMatches">-</div>
            </div>
            <div class="stat-card">
                <h3>Your Wins</h3>
                <div class="value" id="playerWins">-</div>
            </div>
            <div class="stat-card">
                <h3>Your Earnings</h3>
                <div class="value" id="playerEarnings">-</div>
            </div>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="card">
                <h2>üìö Sample Questions (From Blockchain)</h2>
                <div id="questionsList"></div>
            </div>

            <div class="card">
                <h2>üéØ Active Matches</h2>
                <button class="btn" onclick="loadMatches()">Refresh Matches</button>
                <div id="matchesList"></div>
            </div>

            <div class="card">
                <h2>‚ûï Create New Match</h2>
                <div>
                    <label>Entry Fee (tokens):</label>
                    <input type="number" id="entryFee" value="1" min="0.1" step="0.1">
                    
                    <label>Max Players:</label>
                    <select id="maxPlayers">
                        <option value="2">2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4">4 Players</option>
                    </select>
                    
                    <label>Questions Per Match:</label>
                    <select id="questionsPerMatch">
                        <option value="5">5 Questions</option>
                        <option value="10">10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                    </select>
                    
                    <label>Token:</label>
                    <select id="tokenSelect">
                        <option value="0xc2FB5a20d07036d828cBbF2FCEE5cea02cc9Cb2f">mcUSD</option>
                        <option value="0x360Da2CcFE307B5CB0330d062d8D83B721811B76">mUSDC</option>
                        <option value="0xE5eA34847A04d197B22652be1Dc8FbFf11392239">mUSDT</option>
                    </select>
                    
                    <button class="btn" onclick="createMatch()">Create Match</button>
                </div>
            </div>

            <div class="card">
                <h2>üìä Your Statistics</h2>
                <div id="playerStats"></div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0xE40DE1f269E2aD112c6faeaA3df4ECAf2E512869';
        const CHAIN_ID = 11142220; // Celo Sepolia
        
        const CONTRACT_ABI = [
            "function getTotalQuestions() view returns (uint256)",
            "function getActiveQuestionsCount() view returns (uint256)",
            "function getQuestion(uint256) view returns (uint256 id, string questionText, string[4] options, string category, uint8 difficulty, bool isActive)",
            "function getActiveMatches() view returns (uint256[])",
            "function getMatchDetails(uint256) view returns (uint256 matchId, address[] players, address token, uint256 entryFee, uint256 prizePool, uint8 status, uint256 startTime, uint256 endTime, uint8 currentPlayers, uint8 maxPlayers, uint8 questionsPerMatch)",
            "function getPlayerStats(address) view returns (uint256 totalWins, uint256 totalEarnings, uint256 totalMatches, uint256 totalCorrectAnswers, uint256 highestScore)",
            "function createMatch(address token, uint256 entryFee, uint8 maxPlayers, uint8 questionsPerMatch, bool autoStart) returns (uint256)",
            "function joinMatch(uint256 matchId)",
            "function supportedTokens(address) view returns (bool)"
        ];

        let provider, signer, contract, userAddress;

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (parseInt(chainId) !== CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + CHAIN_ID.toString(16) }],
                        });
                    } catch (error) {
                        // Network doesn't exist, add it
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x' + CHAIN_ID.toString(16),
                                chainName: 'Celo Sepolia Testnet',
                                nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
                                rpcUrls: ['https://11142220.rpc.thirdweb.com'],
                                blockExplorerUrls: ['https://celo-sepolia.blockscout.com']
                            }]
                        });
                    }
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('walletInfo').innerHTML = `
                    <div class="success">
                        Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}
                    </div>
                `;

                document.getElementById('statsSection').style.display = 'grid';
                document.getElementById('mainContent').style.display = 'block';

                await loadData();
            } catch (error) {
                console.error(error);
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">Error: ${error.message}</div>
                `;
            }
        }

        async function loadData() {
            try {
                // Load contract stats
                const totalQuestions = await contract.getTotalQuestions();
                const activeQuestions = await contract.getActiveQuestionsCount();
                const activeMatches = await contract.getActiveMatches();
                const playerStats = await contract.getPlayerStats(userAddress);

                document.getElementById('totalQuestions').textContent = totalQuestions.toString();
                document.getElementById('activeMatches').textContent = activeMatches.length;
                document.getElementById('playerWins').textContent = playerStats.totalWins.toString();
                document.getElementById('playerEarnings').textContent = ethers.utils.formatEther(playerStats.totalEarnings);

                // Load sample questions
                await loadQuestions();
                
                // Load matches
                await loadMatches();
                
                // Load player stats
                await loadPlayerStats();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadQuestions() {
            try {
                const total = await contract.getTotalQuestions();
                const count = Math.min(3, parseInt(total.toString()));
                let html = '';

                for (let i = 1; i <= count; i++) {
                    const q = await contract.getQuestion(i);
                    html += `
                        <div class="question-card">
                            <strong>Q${i}: ${q.questionText}</strong>
                            <div style="margin-top: 10px;">
                                ${q.options.map((opt, idx) => `<div class="option">${String.fromCharCode(65 + idx)}. ${opt}</div>`).join('')}
                            </div>
                            <div style="margin-top: 10px; color: #666;">
                                Category: ${q.category} | Difficulty: ${'‚≠ê'.repeat(q.difficulty)}
                            </div>
                        </div>
                    `;
                }

                document.getElementById('questionsList').innerHTML = html || '<p>No questions found.</p>';
            } catch (error) {
                document.getElementById('questionsList').innerHTML = `<div class="error">Error loading questions: ${error.message}</div>`;
            }
        }

        async function loadMatches() {
            try {
                const matchIds = await contract.getActiveMatches();
                let html = '';

                for (const matchId of matchIds.slice(0, 5)) {
                    const match = await contract.getMatchDetails(matchId);
                    const statusNames = ['Waiting', 'Active', 'Completed', 'Cancelled'];
                    const statusClass = ['status-waiting', 'status-active', 'status-completed', 'status-completed'];
                    
                    html += `
                        <div class="match-card">
                            <div>
                                <strong>Match #${matchId}</strong>
                                <div>Entry: ${ethers.utils.formatEther(match.entryFee)} tokens</div>
                                <div>Players: ${match.currentPlayers}/${match.maxPlayers}</div>
                                <div>Questions: ${match.questionsPerMatch}</div>
                            </div>
                            <div>
                                <div class="status ${statusClass[match.status]}">${statusNames[match.status]}</div>
                                ${match.status === 0 ? '<button class="btn" onclick="joinMatch(' + matchId + ')">Join</button>' : ''}
                            </div>
                        </div>
                    `;
                }

                document.getElementById('matchesList').innerHTML = html || '<p>No active matches. Create one!</p>';
            } catch (error) {
                document.getElementById('matchesList').innerHTML = `<div class="error">Error loading matches: ${error.message}</div>`;
            }
        }

        async function loadPlayerStats() {
            try {
                const stats = await contract.getPlayerStats(userAddress);
                document.getElementById('playerStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <strong>Total Wins:</strong> ${stats.totalWins}
                        </div>
                        <div>
                            <strong>Total Matches:</strong> ${stats.totalMatches}
                        </div>
                        <div>
                            <strong>Correct Answers:</strong> ${stats.totalCorrectAnswers}
                        </div>
                        <div>
                            <strong>Highest Score:</strong> ${stats.highestScore}
                        </div>
                        <div>
                            <strong>Total Earnings:</strong> ${ethers.utils.formatEther(stats.totalEarnings)} tokens
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('playerStats').innerHTML = `<div class="error">Error loading stats</div>`;
            }
        }

        async function createMatch() {
            try {
                const entryFee = ethers.utils.parseEther(document.getElementById('entryFee').value);
                const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
                const questionsPerMatch = parseInt(document.getElementById('questionsPerMatch').value);
                const token = document.getElementById('tokenSelect').value;

                // Approve token first (would need ERC20 ABI)
                alert('Please approve tokens in your wallet, then confirm the match creation transaction.');

                const tx = await contract.createMatch(token, entryFee, maxPlayers, questionsPerMatch, true);
                alert('Transaction sent! Waiting for confirmation...');
                await tx.wait();
                alert('Match created successfully!');
                
                await loadData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function joinMatch(matchId) {
            try {
                alert('Please approve tokens in your wallet, then confirm the join transaction.');
                const tx = await contract.joinMatch(matchId);
                alert('Transaction sent! Waiting for confirmation...');
                await tx.wait();
                alert('Joined match successfully!');
                
                await loadData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
